<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archy Chatbot - Live Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <!-- Confetti Library for Celebration Effect -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        theme: 'var(--theme-color)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --theme-color: #a855f7; /* Default Purple */
            --chat-text-size: 15px; /* Default text size */
        }
        body {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-opensans { font-family: 'Open Sans', sans-serif; }
        .font-comic { font-family: 'Comic Neue', cursive; }
        
        .msg-text {
            font-size: var(--chat-text-size);
        }

        @keyframes wave {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(45deg); }
        }
        .animate-wave {
            transform-origin: 75px 55px;
            animation: wave 0.8s ease-in-out infinite alternate;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 20px;
        }

        .message-enter {
            animation: slideUpFade 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        @keyframes slideUpFade {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typing Indicator Animations */
        .typing-dot {
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Highlight animation for live updates */
        @keyframes highlightUpdate {
            0% { background-color: rgba(34, 197, 94, 0.2); }
            100% { background-color: transparent; }
        }
        .live-update {
            animation: highlightUpdate 2s ease-out;
        }

        /* MathJax styling tweaks */
        mjx-container {
            display: inline-block !important;
            margin: 0 !important;
            vertical-align: -0.2em !important;
        }
        
        /* D·ªãch ri√™ng c√°c ch·ªØ x, y, xy l√™n tr√™n ƒë·ªÉ c√πng d√≤ng v·ªõi ch·ªØ text b√¨nh th∆∞·ªùng */
        .math-var mjx-container {
            vertical-align: 0em !important;
        }
    </style>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$$', '$$']],
                displayMath: [] 
            },
            svg: { fontCache: 'global' },
            startup: {
                typeset: false 
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-[100dvh] w-screen overflow-hidden flex justify-center items-center text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <!-- App Container -->
    <div id="app-container" class="w-full max-w-md h-full bg-white dark:bg-gray-800 shadow-2xl relative flex flex-col overflow-hidden transition-all duration-500">
        
        <!-- TEACHER LOGIN MODAL -->
        <div id="password-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl w-80 max-w-[90%] transform transition-all">
                <h3 class="text-lg font-bold mb-4">Teacher Access</h3>
                <input type="password" id="teacher-pwd-input" placeholder="Password (default: 1234)" class="w-full px-4 py-3 border rounded-xl mb-2 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-[var(--theme-color)] outline-none">
                <p id="pwd-error" class="text-red-500 text-xs mb-4 hidden">Incorrect password.</p>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="pwd-cancel" class="px-4 py-2 text-sm font-semibold text-gray-500 hover:text-gray-700">Cancel</button>
                    <button id="pwd-submit" class="px-4 py-2 text-sm font-bold text-white bg-[var(--theme-color)] rounded-xl hover:opacity-90 transition-opacity">Enter</button>
                </div>
            </div>
        </div>

        <!-- SETUP SCREEN -->
        <div id="setup-screen" class="flex-1 overflow-y-auto w-full relative custom-scrollbar">
            <!-- Wrap content in a min-h-full div to ensure vertical centering on large screens, but full scroll on small screens -->
            <div class="min-h-full flex flex-col justify-center items-center p-6 w-full relative">
                
                <!-- Teacher Login Button -->
                <button id="teacher-login-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-[var(--theme-color)] transition-colors focus:outline-none" title="Teacher Dashboard">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                </button>

                <!-- Mascot SVG -->
                <svg width="150" height="150" viewBox="0 0 100 100" class="mb-6 shrink-0">
                    <rect x="25" y="45" width="50" height="40" rx="10" fill="var(--theme-color)"/>
                    <rect x="15" y="15" width="70" height="35" rx="15" fill="var(--theme-color)"/>
                    <circle cx="35" cy="32" r="7" fill="white"/>
                    <circle cx="65" cy="32" r="7" fill="white"/>
                    <circle cx="35" cy="32" r="3" fill="#1f2937"/>
                    <circle cx="65" cy="32" r="3" fill="#1f2937"/>
                    <path d="M 40 42 Q 50 48 60 42" stroke="white" stroke-width="3" fill="transparent" stroke-linecap="round"/>
                    <line x1="50" y1="15" x2="50" y2="5" stroke="var(--theme-color)" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="50" cy="5" r="4" fill="var(--theme-color)"/>
                    <path d="M 25 55 L 10 65" stroke="var(--theme-color)" stroke-width="8" stroke-linecap="round"/>
                    <g class="animate-wave"><path d="M 75 55 L 90 40" stroke="var(--theme-color)" stroke-width="8" stroke-linecap="round"/></g>
                </svg>

                <h1 class="text-2xl font-bold mb-8 text-center shrink-0">Welcome to Archy</h1>

                <div class="w-full space-y-6 bg-gray-50 dark:bg-gray-700/50 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shrink-0">
                    <!-- Group Number Input -->
                    <div>
                        <label class="block text-sm font-medium mb-2 opacity-80">Group Number</label>
                        <input type="number" id="group-input" min="1" max="10" placeholder="e.g. 1 (from 1 to 10)" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color)] transition-all">
                        <p id="group-error" class="text-red-500 text-sm font-medium mt-2 hidden">Please enter a number between 1 and 10.</p>
                    </div>

                    <!-- Font Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2 opacity-80">Font Family</label>
                        <select id="font-select" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color)] transition-all">
                            <option value="font-roboto">Roboto</option>
                            <option value="font-opensans">Open Sans</option>
                            <option value="font-comic">Comic Neue</option>
                        </select>
                    </div>

                    <!-- Text Size Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2 opacity-80">Text Size</label>
                        <select id="text-size-select" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color)] transition-all">
                            <option value="14px">Small</option>
                            <option value="15px" selected>Medium</option>
                            <option value="18px">Large</option>
                        </select>
                    </div>

                    <!-- Color Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2 opacity-80">Theme Color</label>
                        <div class="flex gap-4 justify-center" id="color-picker">
                            <button class="w-10 h-10 rounded-full transition-all color-btn" style="background-color: #a855f7; outline: 2px solid #a855f7; outline-offset: 2px;" data-color="#a855f7"></button>
                            <button class="w-10 h-10 rounded-full transition-all color-btn" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                            <button class="w-10 h-10 rounded-full transition-all color-btn" style="background-color: #10b981;" data-color="#10b981"></button>
                            <button class="w-10 h-10 rounded-full transition-all color-btn" style="background-color: #f43f5e;" data-color="#f43f5e"></button>
                        </div>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between pt-2">
                        <label class="text-sm font-medium opacity-80">Dark Mode</label>
                        <button id="theme-toggle-btn" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-[var(--theme-color)] relative transition-colors duration-300 focus:outline-none">
                            <div id="theme-toggle-circle" class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transform transition-transform duration-300 dark:translate-x-6 shadow-sm"></div>
                        </button>
                    </div>
                </div>

                <button id="start-btn" class="mt-8 w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg hover:opacity-90 transition-all transform hover:scale-[1.02] active:scale-[0.98] shrink-0" style="background-color: var(--theme-color);">
                    Start Learning
                </button>
            </div>
        </div>

        <!-- TEACHER DASHBOARD SCREEN -->
        <div id="teacher-screen" class="hidden flex-1 flex flex-col h-full bg-[#f8f9fa] dark:bg-gray-900 relative">
            <!-- Added shrink-0 to prevent collapsing -->
            <div class="shrink-0 px-5 py-4 flex items-center justify-between text-white shadow-md z-20" style="background-color: var(--theme-color);">
                <div>
                    <h2 class="font-bold text-xl flex items-center gap-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        Teacher Dashboard
                    </h2>
                    <p class="text-xs opacity-80 mt-1 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                        Live updates enabled
                    </p>
                </div>
                <button id="teacher-exit-btn" class="text-sm font-bold bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl transition-colors">Exit</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div id="teacher-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loading placeholder -->
                    <div class="col-span-full text-center text-gray-500 mt-10">Connecting to cloud... Waiting for student data.</div>
                </div>
            </div>
        </div>

        <!-- CHAT SCREEN -->
        <div id="chat-screen" class="hidden flex-1 flex flex-col h-full bg-[#f8f9fa] dark:bg-gray-900 relative">
            
            <!-- Header (Added shrink-0) -->
            <div class="shrink-0 px-4 py-3 flex items-center justify-between text-white shadow-md z-20 transition-colors duration-300" style="background-color: var(--theme-color);">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <rect x="3" y="8" width="18" height="12" rx="3" />
                            <circle cx="8" cy="14" r="2" fill="var(--theme-color)" />
                            <circle cx="16" cy="14" r="2" fill="var(--theme-color)" />
                            <line x1="12" y1="8" x2="12" y2="4" stroke="white" stroke-width="2" />
                            <circle cx="12" cy="3" r="1.5" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-lg leading-tight">Archy</h2>
                        <div class="flex items-center gap-1.5 opacity-90">
                            <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                            <span class="text-xs">Online Now</span>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Menu Toggle -->
                <div class="relative">
                    <button id="menu-btn" class="p-2 hover:bg-white/20 rounded-full transition-colors focus:outline-none">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="settings-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 py-2 text-gray-800 dark:text-gray-200 z-50 origin-top-right transition-all">
                        <div class="px-4 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Settings</div>
                        <div class="px-4 py-2 border-t border-gray-100 dark:border-gray-700">
                            <label class="block text-xs mb-1.5 opacity-80">Font</label>
                            <select id="chat-font-select" class="w-full text-sm bg-gray-50 dark:bg-gray-700/50 rounded p-1.5 focus:outline-none cursor-pointer">
                                <option value="font-roboto">Roboto</option>
                                <option value="font-opensans">Open Sans</option>
                                <option value="font-comic">Comic Neue</option>
                            </select>
                        </div>
                        <div class="px-4 py-2 border-t border-gray-100 dark:border-gray-700">
                            <label class="block text-xs mb-1.5 opacity-80">Text Size</label>
                            <select id="chat-text-size-select" class="w-full text-sm bg-gray-50 dark:bg-gray-700/50 rounded p-1.5 focus:outline-none cursor-pointer">
                                <option value="14px">Small</option>
                                <option value="15px" selected>Medium</option>
                                <option value="18px">Large</option>
                            </select>
                        </div>
                        <div class="px-4 py-3 border-t border-gray-100 dark:border-gray-700">
                            <label class="block text-xs mb-2 opacity-80">Theme Color</label>
                            <div class="flex gap-3">
                                <button class="w-6 h-6 rounded-full transition-all color-btn" style="background-color: #a855f7; outline: 2px solid #a855f7; outline-offset: 2px;" data-color="#a855f7"></button>
                                <button class="w-6 h-6 rounded-full transition-all color-btn" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                                <button class="w-6 h-6 rounded-full transition-all color-btn" style="background-color: #10b981;" data-color="#10b981"></button>
                                <button class="w-6 h-6 rounded-full transition-all color-btn" style="background-color: #f43f5e;" data-color="#f43f5e"></button>
                            </div>
                        </div>
                        <div class="px-4 py-3 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" id="chat-theme-toggle">
                            <span class="text-sm">Dark Mode</span>
                            <div class="w-8 h-4 rounded-full bg-gray-300 dark:bg-[var(--theme-color)] relative pointer-events-none">
                                <div class="w-3 h-3 bg-white rounded-full absolute top-0.5 left-0.5 transform transition-transform dark:translate-x-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chat-area" class="flex-1 overflow-y-auto p-4 space-y-6 pb-24 scroll-smooth custom-scrollbar">
                <!-- Messages will be injected here -->
            </div>

            <!-- Input Area (Fixed Bottom) -->
            <!-- z-20 added to prevent overlapping issues with content behind it -->
            <div id="input-area" class="absolute bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-t border-gray-200 dark:border-gray-700 p-3 transform transition-transform duration-300 translate-y-full flex gap-2 z-20">
                <input type="text" id="chat-input" placeholder="Type your answer here..." class="flex-1 bg-gray-100 dark:bg-gray-900 border border-transparent focus:border-[var(--theme-color)] focus:bg-white dark:focus:bg-gray-800 rounded-full px-5 py-3 outline-none transition-all text-sm">
                <button id="send-btn" class="w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center text-white shadow-md transform active:scale-95 transition-all" style="background-color: var(--theme-color);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC (ES Module for Firebase Integration) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // M·∫¢NG D·ªÆ LI·ªÜU K·ªäCH B·∫¢N CHATBOT
        const scriptData = {
            "0": { type: "mcq", text: "Hello Group [group number]! I am Archy - your AI teaching assisstant today. Which question on Worksheet 4 are you currently stuck on?", options: [{text: "Question 1", next: "2"}, {text: "Question 2", next: "16"}, {text: "Question 3", next: "20"}, {text: "Question 4", next: "33"}] },
            "1": { type: "mcq", text: "That‚Äôs great to hear! Which question on Worksheet 4 do you want to ask next?", options: [{text: "Question 1", next: "2"}, {text: "Question 2", next: "16"}, {text: "Question 3", next: "20"}, {text: "Question 4", next: "33"}, {text: "We don‚Äôt have any questions left!", next: "36"}] },
            "2": { type: "mcq", text: "Question 1 asks you to find the coordinates of specific points and identify what we are looking for. Which part is confusing you?", options: [{text: "How to find the coordinate of the left base?", next: "3"}, {text: "How to find the coordinate of the right base?", next: "5"}, {text: "How to find the coordinate of the specific point on the bridge?", next: "10"}, {text: "What does the height of the vertex of the bridge means?", next: "14"}] },
            "3": { type: "mcq", text: "Just to remind you, we are choosing an $$xy$$-coordinate system so that the left base of the bridge pillar is placed at the origin! Now, what is the coordinates of the origin?", options: [{text: "I don‚Äôt remember‚Ä¶", next: "4"}, {text: "I understand now! I want to ask about another part of question 1.", next: "2"}, {text: "We understand now! We want to ask about another question.", next: "1"}] },
            "4": { type: "mcq", text: "Please remember from now on, the origin of an $$xy$$-coordinate system is always $$(0,0)$$!", options: [{text: "We understand now! We want to ask about another part of question 1.", next: "2"}, {text: "We understand now! We want to ask about another question.", next: "1"}] },
            "5": { type: "mcq", text: "Let‚Äôs look at this figure. We set the left base at the origin $$(0, 0)$$. The $$x$$-axis is the ground. Now try to guess and choose the most correct reasoning to find the coordinates of the right base:", image: "https://i.postimg.cc/Kv2vsPRq/question-5.png", options: [{text: "Because the base is on the ground, the $$x$$-coordinate is 0, and the distance of 27m means the $$y$$-coordinate is 27. The coordinates are $$(0, 27)$$.", next: "7"}, {text: "Because the base is on the ground, the $$y$$-coordinate is 0, and since it's 27m away from the origin, the $$x$$-coordinate is 27. The coordinates are $$(27, 0)$$.", next: "9"}, {text: "Our group thinks that the $$y$$-coordinate is 0, but we don't know how to find the $$x$$-coordinate.", next: "6"}] },
            "6": { type: "input", text: "That‚Äôs completely fine. Look at the figure and remember our choice of the coordinate system.\n\nThis means the $$x$$-axis represents the ground, and the distance from a point on the ground to the left base is exactly the distance from a point on the $$x$$-axis to the origin $$O(0, 0)$$. So, let's try again: Because the base is on the ground, the $$y$$-coordinate is 0, and since it's $$27m$$ away from the origin, the $$x$$-coordinate is ‚Ä¶?", answers: { "27": "9", "default": "8" } },
            "7": { type: "input", text: "Almost there! Just remember something we learned: \"a point on the $$x$$-axis always has a $$y$$-coordinate of 0\". Let's try one more time to find the coordinates of the right base: the $$y$$-coordinate is 0, and since it's $$27m$$ away from the origin, the $$x$$-coordinate is ‚Ä¶?", answers: { "27": "9", "default": "8" } },
            "8": { type: "mcq", text: "Nice guess, but try better next time üòä\nThe distance from the right base to the left base is 27m, and so its distance to the origin $$O(0, 0)$$ is 27. Therefore, its $$x$$-coordinate is 27.", options: [{text: "We understand now! I want to ask about another part of question 1.", next: "2"}, {text: "We understand now! I want to ask about another question.", next: "1"}] },
            "9": { type: "mcq", text: "That is correct! Let me know if you need anything else.", options: [{text: "We want to ask about another part of question 1.", next: "2"}, {text: "We want to ask about another question.", next: "1"}] },
            "10": { type: "mcq", text: "Let me ask a quick question so I can help your group better! What difficulty are you facing right now?", options: [{text: "We are not very sure how the height and distance relate to the coordinates.", next: "11"}, {text: "We don't know if ‚Äúaway from the base‚Äù means the left base or the right base, so we can't decide on the final answer.", next: "13"}] },
            "11": { type: "mcq", text: "Let‚Äôs look at the drawing together and remember that our $$x$$-axis represents the ground. This means the $$x$$-coordinate represents the horizontal distance, and the $$y$$-coordinate represents the vertical height. Now let‚Äôs take a guess:", image: "https://i.postimg.cc/FzQm8vsR/question-11.png", options: [{text: "(2.26, 20)", next: "9"}, {text: "(20, 2.26)", next: "12"}] },
            "12": { type: "mcq", text: "Be careful, you might have them backward! Look at the drawing again. Remember that our $$x$$-axis represents the ground, meaning the $$x$$-coordinate shows the horizontal distance, and the $$y$$-coordinate shows the vertical height.", options: [{text: "We understand now! We want to ask about another part of question 1.", next: "2"}, {text: "We understand now! We want to ask about another question.", next: "1"}] },
            "13": { type: "input", text: "You don't need to overthink it! Actually, because of the symmetry of the parabola, whether you think it's from the left base or the right base, you will still get the correct answer. It will give you the exact same parabola! If you don't believe me, try typing in the coordinates $$(x, y)$$ of this point and remember to use ‚Äòdot‚Äô for decimal (for example: (1.5, 5)):", answers: { "(2.26, 20)": "9", "(24.74, 20)": "9", "(2.26,20)": "9", "(24.74,20)": "9", "(20, 2.26)": "12", "(20,2.26)": "12", "(20, 24.74)": "12", "(20,24.74)": "12", "default": "11" } },
            "14": { type: "mcq", text: "Let‚Äôs take a look at this figure and take a guess! The height of the vertex of the bridge from the ground is‚Ä¶", image: "https://i.postimg.cc/BbgWz1zW/question-14.png", options: [{text: "The $$y$$-coordinate of the parabola's vertex.", next: "9"}, {text: "The $$x$$-coordinate of the parabola's vertex.", next: "15"}, {text: "We don't know T.T", next: "15"}] },
            "15": { type: "mcq", text: "Don‚Äôt worry, let me give you a little hint: the $$x$$-coordinate represents the horizontal distance, and the $$y$$-coordinate represents the vertical height. Let's try again! The height of the vertex of the bridge from the ground is‚Ä¶", options: [{text: "The $$y$$-coordinate of the parabola's vertex.", next: "9"}] },
            "16": { type: "mcq", text: "Question 2 asks you to state the mathematical model for the problem. What is confusing you?", options: [{text: "What does ‚Äúmathematical model‚Äù mean? I don‚Äôt know what I need to write down.", next: "17"}, {text: "We don't understand how the coordinates identified in Question 1 relate to the mathematical problem.", next: "18"}] },
            "17": { type: "mcq", text: "Don‚Äôt worry, it is really easy! To construct a mathematical model, write down the mathematical hypothesis and mathematical goal (request) that you have detected from the real-world problem.", options: [{text: "We don't understand how the coordinates identified in Question 1 relate to the mathematical problem.", next: "18"}, {text: "We understand now!", next: "1"}] },
            "18": { type: "mcq", text: "Let‚Äôs think about this: What can we tell about the three points $$(0,0)$$, $$(27,0)$$, and $$(2.26,20)$$?", options: [{text: "They belong to $$(P)$$", next: "19"}, {text: "We understand now!", next: "1"}] },
            "19": { type: "mcq", text: "That‚Äôs right! Now that is exactly the mathematical hypothesis that we are looking for!", options: [{text: "We understand now!", next: "1"}] },
            "20": { type: "mcq", text: "Question 3 is where we do the heavy mathematical solving! What part are you stuck on?", options: [{text: "Determining the quadratic function.", next: "21"}, {text: "Finding the vertex of the parabola.", next: "26"}, {text: "Oh we think that we know how to answer this question now. We want to ask about another question.", next: "1"}] },
            "21": { type: "mcq", text: "That is a tough part! To determine the quadratic function $$y=ax^2+bx+c$$ is to determine the coefficients $$a,b,c$$.\n\nNow I'll ask a question to see if you can guess what we need to do next: when we know that the point $$(2.26, 20)$$ is on the graph of the function $$y = ax^2 + bx + c$$, what conclusion can we make about the coefficients $$a, b, c$$?", options: [{text: "$$20 = a(2.26)^2 + b(2.26) + c$$", next: "24"}, {text: "$$2.26 = a(20)^2 + b(20) + c$$", next: "23"}, {text: "Please give us a hint :<", next: "22"}] },
            "22": { type: "mcq", text: "Don‚Äôt worry, let me give you a little hint by recalling something we learned in the Functions lesson: \"if a point with coordinates $$(x_0, y_0)$$ belongs to the graph of a function $$y = f(x)$$, then $$y_0 = f(x_0)$$\". Simply put, if a point is on the graph of a function, its coordinates will satisfy that function's equation!\n\nApplying this, when the point $$(2.26, 20)$$ is on the graph of $$y = ax^2 + bx + c$$, which of the following equations do we get?", options: [{text: "$$20 = a.(2.26)^2+b.2.26+c$$", next: "24"}, {text: "$$2.26 = a(20)^2 + b(20) + c$$", next: "23"}] },
            "23": { type: "mcq", text: "Be careful, you have them backward! We need to substitute the $$x$$-coordinate into the $$x$$ variable in the equation, and the $$y$$-coordinate into the $$y$$ variable.", options: [{text: "We understand our mistake. We want to know what we need to do next to find $$a,b,c$$.", next: "24"}, {text: "Oh we think that we know how to asnwer this question now. We want to ask about another question.", next: "1"}] },
            "24": { type: "mcq", text: "Awesome! I believe you can now confidently do the same for the other two points, $$(0, 0)$$ and $$(27, 0)$$.\n\nAfter doing that, we will get 3 linear equations with the variables $$a, b, c$$, right? Let me know how far have you got.", options: [{text: "We have found the 3 linear equations with variables $$a, b, c$$, but we don't know how to find $$a, b, c$$.", next: "25"}, {text: "We can find $$a,b,c$$. We want to ask about another question.", next: "1"}, {text: "We don‚Äôt have any questions left!", next: "36"}] },
            "25": { type: "mcq", text: "Don't worry! In your calculator's menu, look for the \"Equation/Func\" feature, then choose \"Simul Equation\" (System of linear equations) with 3 unknowns.\n\nI will guide you on how to enter the data for the equation $$a(27)^2 + b(27) + c = 0$$, and you can do the same for the other 2 equations!\n\nIn this equation, our variables are $$a, b, c$$, which correspond to the variables $$x, y, z$$ in the calculator. In the calculator, we will enter the coefficient of each variable sequentially (these are the numbers in front of $$a, b, c$$) and the constant term (the number on the other side of the = sign in the equation). So for this equation, we will enter these numbers in order: $$27^2$$, $$27$$, $$1$$, $$0$$.", options: [{text: "Yay, we have solved the system of equations! Now we want to ask about another question.", next: "1"}, {text: "Yay, we have solved the system of equations! We don‚Äôt have any questions left!", next: "36"}] },
            "26": { type: "input", text: "Before telling you how to find the vertex of a parabola, I want to make sure you have found the correct quadratic function. Please type in the coefficient $$a$$ of your quadratic function (round to the nearest thousandth)", answers: { "-0.358": "29", "default": "27" } },
            "27": { type: "mcq", text: "Uh oh, that is not correct ‚òπ Check your calculations and try again, or I can help you!", options: [{text: "We want to try answering again.", next: "28"}, {text: "We want some help in determining the quadratic function.", next: "21"}] },
            "28": { type: "input", text: "Let‚Äôs try again! Please type in the coefficient $$a$$ of your quadratic function (round to the nearest thousandth)", answers: { "-0.358": "29", "default": "27" } },
            "29": { type: "input", text: "That is correct! Now I believe that you have found the correct quadratic function.\n\nNow let me review a lesson with you! To find the $$y$$-coordinate of the vertex of a parabola, you can use 1 of these 3 methods:\n\n1. Apply the formula $$\\left(-\\frac{b}{2a}, -\\frac{\\Delta}{4a}\\right)$$.\n\n2. Find the $$x$$-coordinate of the vertex using the formula $$x = -\\frac{b}{2a}$$, then substitute it into the function's equation to calculate $$y$$.\n\n3. Use the quadratic equation solver on your calculator, press the = button until you reach the $$y_{max}$$ (or $$y_{min}$$) line.\n\nTry to apply 1 of these 3 methods to find the $$y$$-coordinate of the vertex for the graph of the function $$y = -0.358x^2 + 9.658x$$ (round to the nearest tenth).", answers: { "65.1": "32", "13.5": "30", "default": "31" } },
            "30": { type: "input", text: "Be careful, you have them mixed up! The number you just entered is the $$x$$-coordinate of the vertex, not the $$y$$-coordinate! Try answering again.", answers: { "65.1": "32", "default": "31" } },
            "31": { type: "input", text: "Be careful with your calculations! Try calculating it again (or try a different method)!", answers: { "65.1": "32", "default": "31" } },
            "32": { type: "mcq", text: "Excellent! You all did great! Let me know if you need any more help.", options: [{text: "We want to ask another question.", next: "1"}, {text: "We don‚Äôt have any questions left!", next: "36"}] },
            "33": { type: "mcq", text: "For Question 4, you just need to bring your math answer back to reality. If the $$y$$-coordinate of the vertex is 65.1, what is the estimated height of the bridge‚Äôs vertex?", options: [{text: "About 65.1 meters.", next: "34"}, {text: "We are still confused.", next: "35"}, {text: "We understand now. We want to ask another question.", next: "1"}, {text: "We understand now. We don‚Äôt have any questions left!", next: "36"}] },
            "34": { type: "mcq", text: "That is correct! Congratulations!", options: [{text: "We understand now. We want to ask another question.", next: "1"}, {text: "We understand now. We don‚Äôt have any questions left!", next: "36"}] },
            "35": { type: "mcq", text: "It is okay, you just need to remember that our $$y$$-coordinate represents vertical height, and the unit is meters. Therefore, the estimated height of the bridge‚Äôs vertex is about 65.1 meters.", options: [{text: "We understand now. We want to ask another question.", next: "1"}, {text: "We understand now. We don‚Äôt have any questions left!", next: "36"}] },
            "36": { type: "end", text: "Congratulations! I'm sure that after this conversation, you can easily complete the worksheet and confidently present your answers to the class. Let's quickly write everything down before the discussion time ends!" }
        };

        // --- B∆Ø·ªöC 1: ƒêI·ªÄN C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
        // Thay th·∫ø c√°c ch·ªØ "YOUR_..." b·∫±ng th√¥ng tin b·∫°n l·∫•y ƒë∆∞·ª£c t·ª´ Firebase Console
        const firebaseConfig = {
  apiKey: "AIzaSyAq3_p3fRQ8vpuXYPffJgIHpRSyASiRwZA",
  authDomain: "archy-chatbot.firebaseapp.com",
  projectId: "archy-chatbot",
  storageBucket: "archy-chatbot.firebasestorage.app",
  messagingSenderId: "297839241279",
  appId: "1:297839241279:web:f5b772d0b92371744ab08a",
  measurementId: "G-7Q87ZXGYS5"
};

        // Firebase Setup
        let db = null;
        let auth = null;
        let currentUser = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'archy-chatbot-live';

        async function initFirebase() {
            try {
                // ∆Øu ti√™n m√¥i tr∆∞·ªùng th·ª≠ nghi·ªám (n·∫øu c√≥), n·∫øu kh√¥ng th√¨ d√πng myFirebaseConfig c·ªßa b·∫°n
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (myFirebaseConfig.apiKey !== "YOUR_API_KEY") {
                    firebaseConfig = myFirebaseConfig;
                } else {
                    console.log("Ch∆∞a thi·∫øt l·∫≠p Firebase. H·ªá th·ªëng ch·ªâ ch·∫°y c·ª•c b·ªô, t√≠nh nƒÉng Gi√°o vi√™n t·∫°m th·ªùi b·ªã v√¥ hi·ªáu ho√°.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // X√°c th·ª±c t√†i kho·∫£n ·∫©n danh ƒë·ªÉ c√≥ quy·ªÅn l∆∞u d·ªØ li·ªáu
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }

        // Global State
        let currentGroup = "1";
        let currentNode = "0";
        let isDarkMode = false;
        let typingIndicatorElement = null;
        let chatHistoryData = []; 
        let teacherUnsubscribe = null;
        
        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const chatScreen = document.getElementById('chat-screen');
        const teacherScreen = document.getElementById('teacher-screen');
        const startBtn = document.getElementById('start-btn');
        const groupInput = document.getElementById('group-input');
        const fontSelect = document.getElementById('font-select');
        const textSizeSelect = document.getElementById('text-size-select');
        const themeToggleBtns = [document.getElementById('theme-toggle-btn'), document.getElementById('chat-theme-toggle')];
        const chatArea = document.getElementById('chat-area');
        const inputArea = document.getElementById('input-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const menuBtn = document.getElementById('menu-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');
        const chatFontSelect = document.getElementById('chat-font-select');
        const chatTextSizeSelect = document.getElementById('chat-text-size-select');
        
        // Teacher Elements
        const teacherLoginBtn = document.getElementById('teacher-login-btn');
        const passwordModal = document.getElementById('password-modal');
        const pwdInput = document.getElementById('teacher-pwd-input');
        const pwdSubmit = document.getElementById('pwd-submit');
        const pwdCancel = document.getElementById('pwd-cancel');
        const pwdError = document.getElementById('pwd-error');
        const teacherExitBtn = document.getElementById('teacher-exit-btn');
        const teacherGrid = document.getElementById('teacher-grid');

        // Allow scroll to be called from dynamically injected HTML
        window.scrollToBottom = () => {
            setTimeout(() => {
                chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
            }, 50);
        };

        function init() {
            initFirebase(); // Kh·ªüi t·∫°o Firebase ng·∫ßm

            fontSelect.addEventListener('change', (e) => setFont(e.target.value));
            chatFontSelect.addEventListener('change', (e) => setFont(e.target.value));
            textSizeSelect.addEventListener('change', (e) => setTextSize(e.target.value));
            chatTextSizeSelect.addEventListener('change', (e) => setTextSize(e.target.value));

            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    setColor(color);
                    document.querySelectorAll('.color-btn').forEach(b => {
                        if (b.dataset.color === color) {
                            b.style.outline = `2px solid ${color}`;
                            b.style.outlineOffset = "2px";
                        } else {
                            b.style.outline = "none";
                        }
                    });
                });
            });

            themeToggleBtns.forEach(btn => btn.addEventListener('click', toggleDarkMode));

            // START BUTTON
            startBtn.addEventListener('click', () => {
                const errorEl = document.getElementById('group-error');
                const groupVal = parseInt(groupInput.value.trim());
                const minGroup = 1, maxGroup = 10;

                if (isNaN(groupVal) || groupVal < minGroup || groupVal > maxGroup) {
                    errorEl.textContent = `Please enter a number between ${minGroup} and ${maxGroup}.`;
                    errorEl.classList.remove('hidden');
                    return; 
                }
                errorEl.classList.add('hidden');
                currentGroup = groupVal.toString();
                
                setupScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                preloadImages();
                
                chatFontSelect.value = fontSelect.value;
                chatTextSizeSelect.value = textSizeSelect.value;
                setTimeout(() => renderNode(currentNode), 300);
            });

            // TEACHER LOGIN FLOW
            teacherLoginBtn.addEventListener('click', () => {
                passwordModal.classList.remove('hidden');
                pwdInput.value = '';
                pwdError.classList.add('hidden');
                pwdInput.focus();
            });
            pwdCancel.addEventListener('click', () => passwordModal.classList.add('hidden'));
            pwdSubmit.addEventListener('click', handleTeacherLogin);
            pwdInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleTeacherLogin() });
            
            teacherExitBtn.addEventListener('click', () => {
                stopTeacherListener();
                teacherScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                appContainer.classList.remove('max-w-6xl', 'w-[95vw]');
                appContainer.classList.add('max-w-md');
            });

            // MENU EVENTS
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', () => settingsDropdown.classList.add('hidden'));
            settingsDropdown.addEventListener('click', (e) => e.stopPropagation());

            sendBtn.addEventListener('click', handleTextInput);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleTextInput(); });
        }

        function handleTeacherLogin() {
            if (pwdInput.value === "1234") {
                passwordModal.classList.add('hidden');
                setupScreen.classList.add('hidden');
                teacherScreen.classList.remove('hidden');
                
                // Expand container to give teacher more space
                appContainer.classList.remove('max-w-md');
                appContainer.classList.add('max-w-6xl', 'w-[95vw]');
                
                startTeacherListener();
            } else {
                pwdError.classList.remove('hidden');
            }
        }

        function preloadImages() {
            for (const key in scriptData) {
                if (scriptData[key].image) {
                    const img = new Image();
                    img.src = scriptData[key].image;
                }
            }
        }

        async function recordAnswer(questionId, userResponseText) {
            const questionText = formatBotText(scriptData[questionId].text);
            const timeStr = new Date().toLocaleTimeString();
            
            chatHistoryData.push({
                time: timeStr,
                questionId: questionId,
                question: questionText.replace(/<br>/g, ' ').trim(),
                answer: userResponseText,
                timestamp: Date.now()
            });

            // L∆∞u l√™n Firebase Cloud
            if (currentUser && db) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_logs', currentGroup);
                    await setDoc(docRef, {
                        group: currentGroup,
                        history: chatHistoryData,
                        lastActive: Date.now()
                    }, { merge: true });
                } catch (e) {
                    console.error("Cloud Save Error:", e);
                }
            }
        }

        // --- H·ªÜ TH·ªêNG L·∫ÆNG NGHE D·ªÆ LI·ªÜU ƒê√ÅM M√ÇY (CHO GI√ÅO VI√äN) ---
        function startTeacherListener() {
            if (!currentUser || !db) {
                teacherGrid.innerHTML = '<div class="col-span-full text-center text-red-500 mt-10">Cloud disconnected. Unable to fetch live data.</div>';
                return;
            }
            
            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat_logs');
            teacherGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 mt-10">Waiting for student data...</div>';

            // L∆∞u state c≈© ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng nh√°y khi c√≥ c·∫≠p nh·∫≠t m·ªõi
            let previousTimestamps = {};

            teacherUnsubscribe = onSnapshot(logsRef, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => { data.push(doc.data()); });
                
                // S·∫Øp x·∫øp c√°c nh√≥m theo th·ª© t·ª± tƒÉng d·∫ßn
                data.sort((a, b) => parseInt(a.group) - parseInt(b.group));
                
                if (data.length === 0) return;
                teacherGrid.innerHTML = '';

                data.forEach(groupData => {
                    const card = document.createElement('div');
                    let isNewUpdate = false;
                    
                    if (previousTimestamps[groupData.group] && previousTimestamps[groupData.group] < groupData.lastActive) {
                        isNewUpdate = true;
                    }
                    previousTimestamps[groupData.group] = groupData.lastActive;

                    card.className = `bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border ${isNewUpdate ? 'border-green-400 live-update' : 'border-gray-200 dark:border-gray-700'} h-[350px] flex flex-col transition-all`;
                    
                    const historyHtml = (groupData.history || []).map(h => `
                        <div class="mb-4 border-b border-gray-100 dark:border-gray-700 pb-3 last:border-0 last:mb-0">
                            <p class="text-[11px] text-gray-400 mb-1 font-mono">[${h.time}]</p>
                            <p class="text-[13px] text-gray-600 dark:text-gray-300 mb-1.5 line-clamp-2" title="${h.question}">${h.question}</p>
                            <p class="text-sm font-bold text-[var(--theme-color)]">A: ${h.answer}</p>
                        </div>
                    `).reverse().join(''); // Reverse ƒë·ªÉ hi·ªÉn th·ªã c√¢u m·ªõi nh·∫•t ·ªü tr√™n c√πng

                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="font-bold text-lg">Group ${groupData.group}</h3>
                            <span class="text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-700 px-2 py-1 rounded-md">
                                ${groupData.history?.length || 0} interactions
                            </span>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                            ${historyHtml || '<p class="text-xs text-gray-400 italic">No answers yet.</p>'}
                        </div>
                    `;
                    teacherGrid.appendChild(card);
                });
            }, (error) => {
                console.error("Firebase listen error:", error);
            });
        }

        function stopTeacherListener() {
            if (teacherUnsubscribe) {
                teacherUnsubscribe();
                teacherUnsubscribe = null;
            }
        }

        // --- C√ÅC H√ÄM TI·ªÜN √çCH GIAO DI·ªÜN ---
        function downloadReport() {
            let content = `=====================================\n ARCHY CHATBOT - SESSION REPORT\n=====================================\nGroup Number: ${currentGroup}\nDate: ${new Date().toLocaleString()}\n=====================================\n\n`;
            chatHistoryData.forEach((item, index) => {
                content += `[${item.time}] Step ${index + 1}:\nQ: ${item.question}\n=> Answer: ${item.answer}\n\n`;
            });
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Group_${currentGroup}_Archy_Report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function setFont(fontClass) {
            document.body.classList.remove('font-roboto', 'font-opensans', 'font-comic');
            document.body.classList.add(fontClass);
            fontSelect.value = fontClass;
            chatFontSelect.value = fontClass;
        }

        function setColor(hex) { document.documentElement.style.setProperty('--theme-color', hex); }
        function setTextSize(size) {
            document.documentElement.style.setProperty('--chat-text-size', size);
            textSizeSelect.value = size; chatTextSizeSelect.value = size;
            window.scrollToBottom();
        }
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            isDarkMode ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
        }
        function formatBotText(text) {
            let t = text.replace(/\[group number\]/gi, currentGroup);
            t = t.replace(/\n\n/g, '<br><br>');
            t = t.replace(/\n/g, '<br>');
            
            // Ch·ªâ b·ªçc ri√™ng bi·∫øn x (v√≠ d·ª•: x-axis, x-coordinate) v√†o th·∫ª span.math-var ƒë·ªÉ CSS d·ªãch l√™n
            // C√°c bi·∫øn y, xy s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng v√† gi·ªØ nguy√™n v·ªã tr√≠ d·ªãch xu·ªëng
            t = t.replace(/\$\$x\$\$/g, (match) => `<span class="math-var">${match}</span>`);
            
            return t;
        }
        function updateMathJax() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([chatArea]).catch((err) => console.log('MathJax error:', err));
            }
        }

        function showTypingIndicator() {
            if (typingIndicatorElement) return;
            typingIndicatorElement = document.createElement('div');
            typingIndicatorElement.className = "flex w-full gap-3 message-enter";
            typingIndicatorElement.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-[var(--theme-color)] flex-shrink-0 flex items-center justify-center mt-1 shadow-sm opacity-60">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><rect x="3" y="8" width="18" height="12" rx="3" /><circle cx="8" cy="14" r="1.5" fill="var(--theme-color)" /><circle cx="16" cy="14" r="1.5" fill="var(--theme-color)" /><line x1="12" y1="8" x2="12" y2="4" stroke="white" stroke-width="2" /><circle cx="12" cy="3" r="1" /></svg>
                </div>
                <div class="flex-1">
                    <span class="text-xs text-gray-400 font-medium mb-1 ml-1 block">Archy is typing</span>
                    <div class="inline-block bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-sm rounded-2xl rounded-tl-sm px-4 py-3">
                        <div class="flex gap-1.5 items-center h-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-gray-400 dark:bg-gray-500 typing-dot"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-gray-400 dark:bg-gray-500 typing-dot"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-gray-400 dark:bg-gray-500 typing-dot"></div>
                        </div>
                    </div>
                </div>`;
            chatArea.appendChild(typingIndicatorElement);
            window.scrollToBottom();
        }

        function removeTypingIndicator() {
            if (typingIndicatorElement) {
                typingIndicatorElement.remove();
                typingIndicatorElement = null;
            }
        }

        function appendBotMessage(text, isError = false, imageUrl = null) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex w-full gap-3 message-enter";
            let imageHtml = imageUrl ? `<img src="${imageUrl}" alt="Bot Image" class="mt-3 rounded-lg max-w-[280px] w-full h-auto border border-gray-200 dark:border-gray-700 shadow-sm" onload="window.scrollToBottom()">` : '';
            wrapper.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-[var(--theme-color)] flex-shrink-0 flex items-center justify-center mt-1 shadow-sm">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><rect x="3" y="8" width="18" height="12" rx="3" /><circle cx="8" cy="14" r="1.5" fill="var(--theme-color)" /><circle cx="16" cy="14" r="1.5" fill="var(--theme-color)" /><line x1="12" y1="8" x2="12" y2="4" stroke="white" stroke-width="2" /><circle cx="12" cy="3" r="1" /></svg>
                </div>
                <div class="flex-1 overflow-hidden">
                    <span class="text-xs text-gray-400 font-medium mb-1 ml-1 block">Archy</span>
                    <div class="msg-text leading-relaxed ${isError ? 'text-red-500 font-medium' : 'text-gray-800 dark:text-gray-100'} bg-transparent">
                        ${text}${imageHtml}
                    </div>
                </div>`;
            chatArea.appendChild(wrapper);
            updateMathJax();
            window.scrollToBottom();
            return wrapper;
        }

        function appendUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex w-full justify-end message-enter";
            wrapper.innerHTML = `<div class="msg-text max-w-[80%] px-5 py-3 rounded-2xl rounded-tr-sm text-white shadow-sm" style="background-color: var(--theme-color);">${text}</div>`;
            chatArea.appendChild(wrapper);
            updateMathJax();
            window.scrollToBottom();
        }

        function showInputArea(show) {
            if (show) {
                inputArea.classList.remove('translate-y-full');
                chatInput.focus();
            } else {
                inputArea.classList.add('translate-y-full');
                chatInput.blur();
            }
        }

        function appendRatingWidget() {
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col items-center justify-center mt-6 p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 message-enter w-full max-w-[90%] mx-auto";
            wrapper.innerHTML = `
                <p class="text-sm font-medium text-center mb-3 text-gray-700 dark:text-gray-300">Are you satisfy with this conversation?</p>
                <div class="flex gap-2" id="star-container">
                    ${[1, 2, 3, 4, 5].map(i => `<button class="star-btn focus:outline-none transition-transform transform hover:scale-110" data-val="${i}"><svg class="w-8 h-8 text-gray-300 dark:text-gray-600 transition-colors" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg></button>`).join('')}
                </div>
                <p id="thank-you-text" class="text-xs text-[var(--theme-color)] mt-2 opacity-0 transition-opacity font-medium">Thank you for your feedback!</p>
                <button id="download-report-btn" class="mt-4 px-6 py-2.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-full text-sm font-bold transition-colors flex items-center gap-2"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Download Report</button>
            `;
            chatArea.appendChild(wrapper);
            window.scrollToBottom();
            
            wrapper.querySelectorAll('.star-btn').forEach((star, idx) => {
                star.addEventListener('click', () => {
                    wrapper.querySelectorAll('svg').forEach((svg, i) => {
                        if (i <= idx) { svg.classList.remove('text-gray-300', 'dark:text-gray-600'); svg.classList.add('text-yellow-400'); } 
                        else { svg.classList.add('text-gray-300', 'dark:text-gray-600'); svg.classList.remove('text-yellow-400'); }
                    });
                    wrapper.querySelector('#thank-you-text').classList.remove('opacity-0');
                    wrapper.querySelector('#thank-you-text').classList.add('opacity-100');
                });
            });
            wrapper.querySelector('#download-report-btn').addEventListener('click', downloadReport);
        }

        function renderNode(id) {
            currentNode = id;
            const node = scriptData[id];
            if (!node) return;
            showInputArea(false);
            showTypingIndicator();

            setTimeout(() => {
                removeTypingIndicator();
                appendBotMessage(formatBotText(node.text), false, node.image);

                if (node.type === "mcq") {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = "flex flex-wrap gap-2 mt-3 ml-11 message-enter";
                    
                    node.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "px-6 py-3.5 rounded-3xl border border-[var(--theme-color)] text-[var(--theme-color)] hover:bg-[var(--theme-color)] hover:text-white transition-colors msg-text font-medium bg-white dark:bg-gray-800 text-left leading-snug";
                        btn.innerHTML = formatBotText(opt.text);
                        btn.onclick = () => {
                            Array.from(optionsContainer.children).forEach(c => { c.disabled = true; c.classList.add('opacity-50', 'cursor-not-allowed'); });
                            optionsContainer.style.display = 'none';
                            appendUserMessage(opt.text);
                            recordAnswer(currentNode, opt.text);
                            renderNode(opt.next);
                        };
                        optionsContainer.appendChild(btn);
                    });
                    chatArea.appendChild(optionsContainer);
                    updateMathJax();
                    window.scrollToBottom();
                } 
                else if (node.type === "input") {
                    showInputArea(true);
                }
                else if (node.type === "end") {
                    if (window.confetti) {
                        const themeColor = document.documentElement.style.getPropertyValue('--theme-color') || '#a855f7';
                        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: [themeColor, '#fbbf24', '#ffffff', '#3b82f6', '#10b981'] });
                    }
                    setTimeout(appendRatingWidget, 800);
                }
            }, 1200);
        }

        function handleTextInput() {
            const val = chatInput.value.trim();
            if (!val) return;
            const node = scriptData[currentNode];
            if (!node || node.type !== "input") return;

            if (!/^[0-9\(\)\-\.\s,]+$/.test(val)) {
                appendBotMessage("For coordinates, please type '(x, y)' including brackets and a space. Remember to use ‚Äòdot‚Äô for decimal point.", true);
                chatInput.value = '';
                return;
            }

            appendUserMessage(val);
            chatInput.value = '';
            showInputArea(false);
            recordAnswer(currentNode, val);

            let nextNode = node.answers["default"];
            for (let key in node.answers) {
                if (key !== "default" && val === key) {
                    nextNode = node.answers[key];
                    break;
                }
            }
            renderNode(nextNode);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>